<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸ›¡ï¸ 4æ®µéšè¦å¡ãƒ©ã‚¤ãƒ–å®Ÿé¨“</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; padding: 50px; }
        .status { font-size: 1.5rem; margin: 20px; color: #00d4ff; }
        button { padding: 20px 40px; font-size: 1.2rem; cursor: pointer; border-radius: 10px; border: none; background: #007bff; color: white; transition: 0.3s; }
        button:disabled { background: #444; }
        .log-box { background: #000; color: #0f0; padding: 15px; margin-top: 20px; text-align: left; height: 150px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ Gemini Live è¦å¡æ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <div id="status" class="status">å¾…æ©Ÿä¸­...</div>
    <button id="startBtn">å¯¾è©±ã‚’é–‹å§‹ï¼ˆé–‹é€šãƒ†ã‚¹ãƒˆï¼‰</button>
    <div class="log-box" id="logs">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°...</div>

    <script>
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const startBtn = document.getElementById('startBtn');
        let ws, audioCtx, nextStartTime = 0;

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsEl.appendChild(div);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            statusEl.textContent = "æ¥ç¶šä¸­...";
            addLog("Go (3000ç•ª) ã«æ¥ç¶šä¸­...");

            // 1. WebSocketæ¥ç¶š (GoçµŒç”±ã§Rustã¸)
            ws = new WebSocket('ws://localhost:3000/ws');
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                statusEl.textContent = "æ¥ç¶šæˆåŠŸï¼å–‹ã£ã¦ãã ã•ã„";
                addLog("é–‹é€šï¼Geminiã«æŒ¨æ‹¶ã‚’é€ã‚Šã¾ã™...");
                const setup = { setup: { model: "models/gemini-2.0-flash-exp" } };
                ws.send(JSON.stringify(setup));
                startRecording();
            };

            ws.onmessage = async (e) => {
                if (e.data instanceof ArrayBuffer) {
                    addLog("Geminiã®éŸ³å£°ã‚’å—ä¿¡ä¸­...");
                    playAudio(e.data);
                }
            };

            ws.onerror = () => {
                statusEl.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼";
                addLog("ã‚¨ãƒ©ãƒ¼ï¼šGoã‹RustãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„");
            };
        };

        // --- éŸ³å£°å†ç”Ÿ ---
        async function playAudio(data) {
            if (!audioCtx) audioCtx = new AudioContext({ sampleRate: 24000 });
            const int16 = new Int16Array(data);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 32768;

            const buffer = audioCtx.createBuffer(1, float32.length, 24000);
            buffer.getChannelData(0).set(float32);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            const start = Math.max(audioCtx.currentTime, nextStartTime);
            source.start(start);
            nextStartTime = start + buffer.duration;
        }

        // --- éŒ²éŸ³é€ä¿¡ ---
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            if (!audioCtx) audioCtx = new AudioContext({ sampleRate: 16000 });
            const source = audioCtx.createMediaStreamSource(stream);
            const processor = audioCtx.createScriptProcessor(4096, 1, 1);

            processor.onaudioprocess = (e) => {
                const input = e.inputBuffer.getChannelData(0);
                const pcm16 = new Int16Array(input.length);
                for (let i = 0; i < input.length; i++) pcm16[i] = input[i] * 32767;
                if (ws.readyState === WebSocket.OPEN) ws.send(pcm16.buffer);
            };
            source.connect(processor);
            processor.connect(audioCtx.destination);
        }
    </script>
</body>
</html>